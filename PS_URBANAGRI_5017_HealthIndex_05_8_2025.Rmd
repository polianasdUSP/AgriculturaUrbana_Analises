---
title: "Health Index"
output: html_notebook
---


```{r}
# Carregue o pacote
library(readr)
library(dplyr)
library(cluster)   # para daisy()
library(ggplot2)
library(tidyr)




```


```{r}
#====== Cluster binarios (sim/nao) ========#

#Criar metadados binários para fazer kmeans (distância euclideana) e pcoa

metadados_upset <- metadados.all.filtrado %>%
  mutate(
    High_Triglycerides = ifelse(!is.na(Triglycerides) & Triglycerides > 150, 1, 0),
    High_Fasting_Glucose = ifelse(!is.na(Glucose) & Glucose > 100, 1, 0),
    Obesity = ifelse(BMI >= 30, 1, 0),  # BMI tem 0 NA, sem ifelse extra
    Low_HDL = ifelse(!is.na(HDL) & HDL < 40, 1, 0),
    High_Blood_Pressure = ifelse(!is.na(Systolic) & !is.na(Diastolic) &
                                   (Systolic >= 130 | Diastolic >= 85), 1, 0)
  )
```


```{r}
#==================== Clusters binários = Completo ===========#

#Criar metadados binários para fazer kmeans (distância euclideana) e pcoa

metadados_grupos_saude_binario <- metadados.all.filtrado %>%
  mutate(
    # Pressão arterial
    High_Blood_Pressure = ifelse(!is.na(Systolic) & !is.na(Diastolic) &
                                   (Systolic >= 130 | Diastolic >= 85), 1, 0),
    
    # Glucose de jejum
    High_Fasting_Glucose = case_when(
      is.na(Glucose) ~ NA_integer_,
      Glucose <= 100 ~ 0,                 # normal
     Glucose > 100 & Glucose < 126 ~ 1,  # alterada (pré-diabetes)
      Glucose >= 126 ~ 2                  # muito alta (diabetes)
    ),
    
    # HbA1c em porcentagem
    HbA1c_cat = case_when(
      is.na(HbA1c) ~ NA_integer_,
      HbA1c < 6.0 ~ 0,
      HbA1c >= 6.0 & HbA1c < 6.5 ~ 1,
      HbA1c >= 6.5 ~ 2
    ),
    
    
    # BMI categorizado por faixa etária
    BMI_cat = case_when(
      is.na(BMI) | is.na(Age) ~ NA_integer_,
      Age >= 60 & BMI < 22 ~ 1,
      Age >= 60 & BMI >= 22 & BMI < 27 ~ 0,
      Age >= 60 & BMI >= 27 & BMI < 30 ~ 1,
      Age >= 60 & BMI >= 30 & BMI < 35 ~ 2,
      Age >= 60 & BMI >= 35 ~ 3,
      Age < 60 & BMI < 18.5 ~ 1,
      Age < 60 & BMI >= 18.5 & BMI < 25 ~ 0,
      Age < 60 & BMI >= 25 & BMI < 30 ~ 1,
      Age < 60 & BMI >= 30 & BMI < 35 ~ 2,
      Age < 60 & BMI >= 35 & BMI < 40 ~ 3,
      Age < 60 & BMI >= 40 ~ 4
    ),
    
    # Triglicerídeos
    TRIG_cat = case_when(
      is.na(Triglycerides) ~ NA_integer_,
      Triglycerides < 150 ~ 0,
      Triglycerides >= 150 & Triglycerides < 200 ~ 1,
      Triglycerides >= 200 & Triglycerides < 500 ~ 2,
      Triglycerides >= 500 ~ 3
    ),
    
    # Cholesterol total
    COL_cat = case_when(
      is.na(Cholesterol) ~ NA_integer_,
      Cholesterol <= 190 ~ 0,
      Cholesterol > 190 & Cholesterol <= 240 ~ 1,
      Cholesterol > 240 ~ 2
    ),
    
    
    # HDL
    HDL_cat = case_when(
    is.na(HDL) ~ NA_integer_,
    HDL < 40 ~ 1,        # risco
    HDL >= 40 ~ 0 ),       # normal ou bom
  

    
    # LDL
    LDL_cat = case_when(
      is.na(LDL) ~ NA_integer_,
      LDL < 100 ~ 0,
      LDL >= 100 & LDL < 130 ~ 0,
      LDL >= 130 & LDL < 160 ~ 1,
      LDL >= 160 & LDL < 190 ~ 2,
      LDL >= 190 ~ 3
    ),
    
        # GGT por sexo
    GGT_cat = case_when(
      is.na(GGT) | is.na(Sex) ~ NA_integer_,
      Sex == "Masculino" & GGT <= 48 ~ 0,
      Sex == "Masculino" & GGT > 48 ~ 1,
      Sex == "Feminino" & GGT <= 32 ~ 0,
      Sex == "Feminino" & GGT > 32 ~ 1
    )
  )







```


`
```{r}
#=====================================================#

#       Score metabolico 

#=====================================================#


#Criar metadados binários para fazer kmeans (distância euclideana) e pcoa

metadados_grupos_saude_binario <- metadados.all.filtrado %>%
  mutate(
    # Pressão arterial
    High_Blood_Pressure = ifelse(!is.na(Systolic) & !is.na(Diastolic) &
                                   (Systolic >= 130 | Diastolic >= 85), 1, 0),
    
    # Glucose de jejum
    High_Fasting_Glucose = case_when(
      is.na(Glucose) ~ NA_integer_,
      Glucose <= 100 ~ 0,                 # normal
      Glucose > 100 & Glucose < 126 ~ 1,  # alterada (pré-diabetes)
      Glucose >= 126 ~ 2                  # muito alta (diabetes)
    ),
    
    # HbA1c em porcentagem
    HbA1c_cat = case_when(
      is.na(HbA1c) ~ NA_integer_,
      HbA1c < 6.0 ~ 0,
      HbA1c >= 6.0 & HbA1c < 6.5 ~ 1,
      HbA1c >= 6.5 ~ 2
    ),
    
    
    # BMI categorizado por faixa etária
    BMI_cat = case_when(
      is.na(BMI) | is.na(Age) ~ NA_integer_,
      Age >= 60 & BMI < 22 ~ 1,
      Age >= 60 & BMI >= 22 & BMI < 27 ~ 0,
      Age >= 60 & BMI >= 27 & BMI < 30 ~ 1,
      Age >= 60 & BMI >= 30 & BMI < 35 ~ 2,
      Age >= 60 & BMI >= 35 ~ 3,
      Age < 60 & BMI < 18.5 ~ 1,
      Age < 60 & BMI >= 18.5 & BMI < 25 ~ 0,
      Age < 60 & BMI >= 25 & BMI < 30 ~ 1,
      Age < 60 & BMI >= 30 & BMI < 35 ~ 2,
      Age < 60 & BMI >= 35 & BMI < 40 ~ 3,
      Age < 60 & BMI >= 40 ~ 4
    ),
    
    # Triglicerídeos
    TRIG_cat = case_when(
      is.na(Triglycerides) ~ NA_integer_,
      Triglycerides < 150 ~ 0,
      Triglycerides >= 150 & Triglycerides < 200 ~ 1,
      Triglycerides >= 200 & Triglycerides < 500 ~ 2,
      Triglycerides >= 500 ~ 3
    ),
    
    # Cholesterol total
    COL_cat = case_when(
      is.na(Cholesterol) ~ NA_integer_,
      Cholesterol <= 190 ~ 0,
      Cholesterol > 190 & Cholesterol <= 240 ~ 1,
      Cholesterol > 240 ~ 2
    ),
    
    
    # HDL
    HDL_cat = case_when(
      is.na(HDL) ~ NA_integer_,
      HDL < 40 ~ 1,        # risco
      HDL >= 40 ~ 0 ),       # normal ou bom
    
    
    
    # LDL
    LDL_cat = case_when(
      is.na(LDL) ~ NA_integer_,
      LDL < 100 ~ 0,
      LDL >= 100 & LDL < 130 ~ 0,
      LDL >= 130 & LDL < 160 ~ 1,
      LDL >= 160 & LDL < 190 ~ 2,
      LDL >= 190 ~ 3
    ),
    
    # GGT por sexo
    GGT_cat = case_when(
      is.na(GGT) | is.na(Sex) ~ NA_integer_,
      Sex == "Masculino" & GGT <= 48 ~ 0,
      Sex == "Masculino" & GGT > 48 ~ 1,
      Sex == "Feminino" & GGT <= 32 ~ 0,
      Sex == "Feminino" & GGT > 32 ~ 1
    )
  )
```


```{r}
#Metabolic Score

metadados_grupos_saude_binario <- metadados_grupos_saude_binario %>%
  mutate(
    Metabolic_Score = rowSums(across(c(
      High_Blood_Pressure, High_Fasting_Glucose, HbA1c_cat,
      BMI_cat, TRIG_cat, COL_cat, HDL_cat, LDL_cat, GGT_cat
    ), ~replace_na(., 0)))
  )


#nomear colunas
metadados_grupos_saude_binario <- metadados_grupos_saude_binario %>%
  mutate(
    Health_Status = case_when(
      Metabolic_Score <= 1 ~ "Healthy",
      Metabolic_Score >= 2 & Metabolic_Score <= 4 ~ "Transition",
      Metabolic_Score >= 5 ~ "Unhealthy"
    )
  )




#plotar

library(ggplot2)

ggplot(metadados_grupos_saude_binario, aes(x = Health_Status, y = Metabolic_Score, fill = Health_Status)) +
  geom_boxplot(alpha = 0.8, width = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.6, size = 2) +
  scale_fill_manual(values = c("Healthy" = "#1b9e77", "Transition" = "#d95f02", "Unhealthy" = "#7570b3")) +
  labs(title = "Metabolic Score by Health Group",
       x = "Health Group", y = "Metabolic Score") +
  theme_minimal(base_size = 14)
```





```{r}
#ESSE GRAFICO!!!

df_pizza <- metadados_grupos_saude_binario %>%
  count(Health_Status) %>%
  mutate(
    label = paste0(n, " (", round(n / sum(n) * 100), "%)")
  )



library(ggplot2)

g_pizza <- ggplot(df_pizza, aes(x = "", y = n, fill = Health_Status)) +
  geom_col(width = 1, color = "white") +
  coord_polar(theta = "y") +
  theme_void(base_size = 18) +
  geom_text(aes(label = label), position = position_stack(vjust = 0.5), size = 5) +
  labs(title = "Metabolic Risk Distribution (n=105)") +
  scale_fill_brewer(palette = "Set2")


# Salvar o gráfico em alta resolução
ggsave("C:/Users/polia/OneDrive/Desktop/EstatisticaR/AgrUrbana/16S_AgriUrbana/Planilhas_UrbanAgri/Para_Dissertação/pizza_grupo_metabolico.png",
       plot = g_pizza, width = 10, height = 8, dpi = 300)
```


```{r}
#===== UPSET =====#
library(dplyr)
library(tidyr)

metadados_binarios_puros <- metadados.all.filtrado %>%
  mutate(
    # Pressão arterial
    High_Blood_Pressure = ifelse(Systolic >= 130 | Diastolic >= 85, 1, 0),
    
    # Glucose
    High_Fasting_Glucose = case_when(
      Glucose <= 100 ~ 0,
      Glucose > 100 & Glucose < 126 ~ 1,
      Glucose >= 126 ~ 1,
      TRUE ~ NA_integer_
    ),
    
    # HbA1c
    HbA1c_cat = case_when(
      HbA1c < 6.0 ~ 0,
      HbA1c >= 6.0 & HbA1c < 6.5 ~ 1,
      HbA1c >= 6.5 ~ 1,
      TRUE ~ NA_integer_
    ),
    
    # BMI categorizado por idade
    BMI_cat = case_when(
      Age >= 60 & BMI < 22 ~ 0,
      Age >= 60 & BMI >= 22 & BMI < 27 ~ 0,
      Age >= 60 & BMI >= 27 & BMI < 30 ~ 0,
      Age >= 60 & BMI >= 30 & BMI < 35 ~ 1,
      Age >= 60 & BMI >= 35 ~ 1,
      Age < 60 & BMI < 18.5 ~ 1,
      Age < 60 & BMI >= 18.5 & BMI < 25 ~ 0,
      Age < 60 & BMI >= 25 & BMI < 30 ~ 0,
      Age < 60 & BMI >= 30 & BMI < 35 ~ 1,
      Age < 60 & BMI >= 35 & BMI < 40 ~ 1,
      Age < 60 & BMI >= 40 ~ 1,
      TRUE ~ NA_integer_
    ),
    
    # Triglicerídeos
    TRIG_cat = case_when(
      Triglycerides < 150 ~ 0,
      Triglycerides >= 150 & Triglycerides < 200 ~ 1,
      Triglycerides >= 200 & Triglycerides < 500 ~ 1,
      Triglycerides >= 500 ~ 1,
      TRUE ~ NA_integer_
    ),
    
    # Cholesterol total
    COL_cat = case_when(
      Cholesterol <= 200 ~ 0,
      Cholesterol > 200 & Cholesterol <= 240 ~ 1,
      Cholesterol > 240 ~ 1,
      TRUE ~ NA_integer_
    ),
    
    # HDL
    HDL_cat = case_when(
      HDL < 40 ~ 1,
      HDL >= 40 ~ 0,
      TRUE ~ NA_integer_
    ),
    
    # LDL
    LDL_cat = case_when(
      LDL < 130 ~ 0,
      LDL >= 130 & LDL < 160 ~ 1,
      LDL >= 160 & LDL < 190 ~ 1,
      LDL >= 190 ~ 1,
      TRUE ~ NA_integer_
    ),
    
    # GGT por sexo
    GGT_cat = case_when(
      Sex == "Masculino" & GGT > 48 ~ 1,
      Sex == "Masculino" & GGT <= 48 ~ 0,
      Sex == "Feminino" & GGT > 32 ~ 1,
      Sex == "Feminino" & GGT <= 32 ~ 0,
      TRUE ~ NA_integer_
    )
  ) %>%
  # Substituir todos os NA das variáveis binárias/categóricas por 0
  mutate(across(
    c(High_Blood_Pressure, High_Fasting_Glucose, HbA1c_cat, BMI_cat, TRIG_cat,
      COL_cat, HDL_cat, LDL_cat, GGT_cat),
    ~ replace_na(., 0)
  ))




#install.packages("ComplexUpset")
library(ComplexUpset)
library(ggplot2)


# Selecionar colunas binárias (0 ou 1)
colunas_binarias <- c("High_Blood_Pressure",              
                      "High_Fasting_Glucose",              "HbA1c_cat" ,                         "BMI_cat" ,                          
                    "TRIG_cat",                           "COL_cat"  ,                          "HDL_cat" ,                          
                      "LDL_cat" ,                           "GGT_cat"                           )

# Subset do dataframe com essas variáveis
dados_upset <- metadados_binarios_puros[, colunas_binarias]

# Garantir que todas sejam numéricas (necessário para ComplexUpset)
dados_upset[] <- lapply(dados_upset, as.numeric)

library(ComplexUpset)
library(ggplot2)





# Gráfico final = idosos
p <-upset(
  dados_upset,
  intersect = colunas_binarias,
  base_annotations = list(
    'Intersection size' = intersection_size(
      mapping = aes(fill = "azul"),
      text = list(size = 4)
    ) + 
      scale_fill_manual(values = c("azul" = "#003399"), guide = "none")
  ),
  set_sizes = upset_set_size(
    mapping = aes(fill = "vermelho")
  ) + 
    scale_fill_manual(values = c("vermelho" = "#8B0000"), guide = "none"),
  width_ratio = 0.2
) +
  labs(title = "Metabolic Health Profile (n=105)")


# Exibir
print(p)


ggsave("C:/Users/polia/OneDrive/Desktop/EstatisticaR/AgrUrbana/16S_AgriUrbana/Planilhas_UrbanAgri/Para_Dissertação/upset_metabolic_healthprofile_completen105.png", plot = p, width = 18, height = 10, dpi = 300)
```


```{r}
#======> Citocinas e Metabolic Health Score

#Boxplots com metadados_grupos_saude_binario e tratamento de NA

library(ggplot2)
library(ggpubr)

# Lista das citocinas
citocinas <- c("IL17A", "IFNGamma", "TNF", "IL10", "IL6", "IL4", "IL2")

# Loop para gerar boxplots + Kruskal
for (cit in citocinas) {
  dados <- metadados_grupos_saude_binario[, c("Health_Status", cit)]
  dados <- dados[!is.na(dados[[cit]]), ]  # remove NAs da citocina
  
  # Teste de Kruskal
  p.kruskal <- kruskal.test(reformulate("Health_Status", cit), data = dados)
  print(paste(cit, "- p =", round(p.kruskal$p.value, 4)))
  
  # Gráfico
  p2 <- ggplot(dados, aes(x = Health_Status, y = .data[[cit]], fill = Health_Status)) +
    geom_boxplot() +
    labs(title = paste0(cit, " por grupo metabólico (p = ", round(p.kruskal$p.value, 3), ")"),
         x = "Health Status", y = paste(cit, "(pg/mL)")) +
    theme_minimal(base_size = 14) +
    scale_fill_brewer(palette = "Spectral") +
    theme(legend.position = "none")
  
  print(p2)
}
```


```{r}
#====== Criar um índice inflamatório e outro antiinflamatório (z-score)====#

# Selecionar subconjuntos
inflamatorias <- c("IL6", "TNF", "IFNGamma", "IL17A")
antiinflamatorias <- c("IL10", "IL4", "IL2")

# Escalar (z-score) as citocinas
z_inflam <- scale(metadados_grupos_saude_binario[, inflamatorias])
z_antiinflam <- scale(metadados_grupos_saude_binario[, antiinflamatorias])

# Calcular o escore médio por indivíduo
metadados_grupos_saude_binario$Inflam_Score <- rowMeans(z_inflam, na.rm = TRUE)
metadados_grupos_saude_binario$AntiInflam_Score <- rowMeans(z_antiinflam, na.rm = TRUE)

#=====> Comparar os escores entre os grupos


# Kruskal-Wallis para cada escore
kruskal.test(Inflam_Score ~ Health_Status, data = metadados_grupos_saude_binario)
kruskal.test(AntiInflam_Score ~ Health_Status, data = metadados_grupos_saude_binario)

#=======> Boxplots com interpretação

library(ggplot2)

ggplot(metadados_grupos_saude_binario, aes(x = Health_Status, y = Inflam_Score, fill = Health_Status)) +
  geom_boxplot() +
  labs(title = "Escore inflamatório (z-score médio)", y = "Inflam_Score") +
  theme_minimal(base_size = 14) +
  scale_fill_brewer(palette = "Spectral")
```


```{r}
ggplot(metadados_grupos_saude_binario, aes(x = Health_Status, y = AntiInflam_Score, fill = Health_Status)) +
  geom_boxplot() +
  labs(title = "Escore anti-inflamatório (z-score médio)", y = "AntiInflam_Score") +
  theme_minimal(base_size = 14) +
  scale_fill_brewer(palette = "Spectral")
```


```{r}
#=======>


library(pheatmap)

# Corrigir lista de variáveis (sem duplicata de BMI)
metabolicos <- unique(c("HbA1c", "Glucose", "Insulin", "Cholesterol", 
                        "LDL", "HDL", "Triglycerides", "TGO", "TGP", "GGT", 
                        "BMI", "PCR"))

# Citocinas + escores
citocinas <- c("IL17A", "IFNGamma", "TNF", "IL10", "IL6", "IL4", "IL2", "Inflam_Score", "AntiInflam_Score")

# Inicializar matrizes
cor_matrix <- matrix(NA, nrow = length(citocinas), ncol = length(metabolicos),
                     dimnames = list(citocinas, metabolicos))
p_matrix <- cor_matrix

# Calcular correlação de Spearman com verificação
for (i in citocinas) {
  for (j in metabolicos) {
    x <- metadados_grupos_saude_binario[[i]]
    y <- metadados_grupos_saude_binario[[j]]
    
    if (is.numeric(x) && is.numeric(y)) {
      dados_validos <- complete.cases(x, y)
      if (sum(dados_validos) > 5) {
        teste <- suppressWarnings(cor.test(x[dados_validos], y[dados_validos], method = "spearman"))
        cor_matrix[i, j] <- round(teste$estimate, 2)
        p_matrix[i, j] <- teste$p.value
      }
    }
  }
}

# Remover colunas/linhas com NA em excesso
cor_matrix_clean <- cor_matrix[rowSums(is.na(cor_matrix)) < ncol(cor_matrix), 
                               colSums(is.na(cor_matrix)) < nrow(cor_matrix)]

p_matrix_clean <- p_matrix[rownames(cor_matrix_clean), colnames(cor_matrix_clean)]

# Criar matriz de asteriscos e rótulos
sig_labels <- ifelse(p_matrix_clean < 0.05, "*", "")
labels <- matrix(paste0(cor_matrix_clean, sig_labels), nrow = nrow(cor_matrix_clean),
                 dimnames = dimnames(cor_matrix_clean))

#====> Preparar os dados em formato longo

library(dplyr)
library(tidyr)
library(ggplot2)

# Converter a matriz de correlação para long format
cor_df <- as.data.frame(cor_matrix_clean) %>%
  mutate(Citocina = rownames(.)) %>%
  pivot_longer(-Citocina, names_to = "Parametro", values_to = "Correlacao")

# Adicionar os p-valores e os asteriscos de significância
p_df <- as.data.frame(p_matrix_clean) %>%
  mutate(Citocina = rownames(.)) %>%
  pivot_longer(-Citocina, names_to = "Parametro", values_to = "p_value") %>%
  mutate(asterisco = ifelse(p_value < 0.05, "*", ""))

# Juntar as duas informações
heatmap_df <- left_join(cor_df, p_df, by = c("Citocina", "Parametro")) %>%
  mutate(label = paste0(round(Correlacao, 2), asterisco))

#====> Criar heatmap com ggplot2

heatmap_plot <- ggplot(heatmap_df, aes(x = Parametro, y = Citocina, fill = Correlacao)) +
  geom_tile(color = "white") +
  geom_text(aes(label = label), size = 4) +
  scale_fill_gradient2(low = "navy", mid = "white", high = "firebrick3",
                       midpoint = 0, limit = c(-1, 1), name = "Spearman\nrho") +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid = element_blank()) +
  labs(title = "Correlação Spearman: Citocinas vs. Parâmetros Metabólicos",
       x = "Parâmetros Metabólicos", y = "Citocinas")

# Visualizar
print(heatmap_plot)

# Salvar
ggsave("C:/Users/polia/OneDrive/Desktop/EstatisticaR/AgrUrbana/16S_AgriUrbana/Planilhas_UrbanAgri/Para_Dissertação/heatmap_citocinas_ggplot.png",
       plot = heatmap_plot, width = 12, height = 8, dpi = 300)
```


```{r}
#=====> testar citocinas com alpha
library(ggplot2)

# 1. Listas de variáveis
citocinas <- c("IL17A", "IFNGamma", "TNF", "IL10", "IL6", "IL4", "IL2", "Inflam_Score", "AntiInflam_Score")
alphas <- c("shannon_entropy", "simpson", "pielou_evenness", "chao1", "faith_pd", "observed_features")

# 2. Loop para cada par (citocina x índice de diversidade)
for (cytokine in citocinas) {
  for (alpha in alphas) {
    
    # Remover NA dos dois vetores
    dados_validos <- complete.cases(metadados_grupos_saude_binario[[cytokine]], metadados_grupos_saude_binario[[alpha]])
    
    if (sum(dados_validos) > 5) {
      # Calcular correlação Spearman
      resultado <- cor.test(metadados_grupos_saude_binario[[cytokine]][dados_validos],
                            metadados_grupos_saude_binario[[alpha]][dados_validos],
                            method = "spearman")
      
      # Criar o gráfico
      p <- ggplot(metadados_grupos_saude_binario[dados_validos, ], 
                  aes_string(x = alpha, y = cytokine)) +
        geom_point(color = "#1f78b4", size = 3, alpha = 0.8) +
        geom_smooth(method = "lm", se = FALSE, color = "darkred") +
        theme_minimal(base_size = 14) +
        labs(
          title = paste("R =", round(resultado$estimate, 2), "- p =", signif(resultado$p.value, 3)),
          subtitle = paste(cytokine, "vs", alpha),
          x = alpha,
          y = cytokine
        )
      
      # Salvar em PNG
      nome_arquivo <- paste0("scatter_", cytokine, "_vs_", alpha, ".png")
      ggsave(nome_arquivo, p, width = 6, height = 5, dpi = 300)
    }
  }
}



```


```{r}
#===================================================================#
#             Score Metabolico Adaptado com medicamentos
#===================================================================#

#Vamos adotar uma lógica simples e lógica:

#Situação                                      |	Pontuação
#Não toma remédio e parâmetro está normal      |	0
#Toma remédio e parâmetro está controlado	    |+1
#Toma remédio e parâmetro não está controlado	|+2
#Não toma remédio e tem alteração	            |+1

#Essa lógica permite capturar risco natural, dependência de tratamento, e falha terapêutica.

library(dplyr)
library(stringr)

#Criar a coluna antihipertensive. 1: toma medicamento. 0: nao toma

metadados_grupos_saude_binario <- metadados_grupos_saude_binario %>%
  mutate(
    antihypertensive = ifelse(str_detect(tolower(Disease), "hipertensao"), 1, 0)
  )

metadados_grupos_saude_binario$antihypertensive <- ifelse(
  is.na(metadados_grupos_saude_binario$antihypertensive),
  0,
  metadados_grupos_saude_binario$antihypertensive
)


metadados_grupos_saude_binario <- metadados_grupos_saude_binario %>%
  mutate(
    # Pressão arterial
    High_Blood_Pressure = ifelse(!is.na(Systolic) & !is.na(Diastolic) &
                                   (Systolic >= 130 | Diastolic >= 85), 1, 0),
    
    # Glicemia jejum
    High_Fasting_Glucose = case_when(
      is.na(Glucose) ~ NA_integer_,
      Glucose <= 100 ~ 0,
      Glucose > 100 & Glucose < 126 ~ 1,
      Glucose >= 126 ~ 2
    ),
    
    # HbA1c
    HbA1c_cat = case_when(
      is.na(HbA1c) ~ NA_integer_,
      HbA1c < 6.0 ~ 0,
      HbA1c >= 6.0 & HbA1c < 6.5 ~ 1,
      HbA1c >= 6.5 ~ 2
    ),
    
    # BMI por idade
    BMI_cat = case_when(
      is.na(BMI) | is.na(Age) ~ NA_integer_,
      Age >= 60 & BMI < 22 ~ 1,
      Age >= 60 & BMI >= 22 & BMI < 27 ~ 0,
      Age >= 60 & BMI >= 27 & BMI < 30 ~ 1,
      Age >= 60 & BMI >= 30 & BMI < 35 ~ 2,
      Age >= 60 & BMI >= 35 ~ 3,
      Age < 60 & BMI < 18.5 ~ 1,
      Age < 60 & BMI >= 18.5 & BMI < 25 ~ 0,
      Age < 60 & BMI >= 25 & BMI < 30 ~ 1,
      Age < 60 & BMI >= 30 & BMI < 35 ~ 2,
      Age < 60 & BMI >= 35 & BMI < 40 ~ 3,
      Age < 60 & BMI >= 40 ~ 4
    ),
    
    # Triglicerídeos
    TRIG_cat = case_when(
      is.na(Triglycerides) ~ NA_integer_,
      Triglycerides < 150 ~ 0,
      Triglycerides >= 150 & Triglycerides < 200 ~ 1,
      Triglycerides >= 200 & Triglycerides < 500 ~ 2,
      Triglycerides >= 500 ~ 3
    ),
    
    # Colesterol total
    COL_cat = case_when(
      is.na(Cholesterol) ~ NA_integer_,
      Cholesterol <= 190 ~ 0,
      Cholesterol > 190 & Cholesterol <= 240 ~ 1,
      Cholesterol > 240 ~ 2
    ),
    
    # HDL
    HDL_cat = case_when(
      is.na(HDL) ~ NA_integer_,
      HDL < 40 ~ 1,
      HDL >= 40 ~ 0
    ),
    
    # LDL
    LDL_cat = case_when(
      is.na(LDL) ~ NA_integer_,
      LDL < 100 ~ 0,
      LDL >= 100 & LDL < 130 ~ 0,
      LDL >= 130 & LDL < 160 ~ 1,
      LDL >= 160 & LDL < 190 ~ 2,
      LDL >= 190 ~ 3
    ),
    
    # GGT por sexo
    GGT_cat = case_when(
      is.na(GGT) | is.na(Sex) ~ NA_integer_,
      Sex == "Masculino" & GGT <= 48 ~ 0,
      Sex == "Masculino" & GGT > 48 ~ 1,
      Sex == "Feminino" & GGT <= 32 ~ 0,
      Sex == "Feminino" & GGT > 32 ~ 1
    ),
    
    # Score para Hipertensão
    Score_Hipertensao = case_when(
      tolower(antihypertensive) == "sim" & High_Blood_Pressure == 1 ~ 2,
      tolower(antihypertensive) == "sim" & High_Blood_Pressure == 0 ~ 1,
      tolower(antihypertensive) != "sim" & High_Blood_Pressure == 1 ~ 1,
      TRUE ~ 0
    ),
    
    # Score para Colesterol
    Score_Colesterol = case_when(
      tolower(Statins) == "sim" & COL_cat >= 1 ~ 2,
      tolower(Statins) == "sim" & COL_cat == 0 ~ 1,
      tolower(Statins) != "sim" & COL_cat >= 1 ~ 1,
      TRUE ~ 0
    ),
    
    # Score para Glicemia (Metformina)
    Score_Glicemia = case_when(
      tolower(Metformin) == "sim" & (High_Fasting_Glucose >= 1 | HbA1c_cat >= 1) ~ 2,
      tolower(Metformin) == "sim" & High_Fasting_Glucose == 0 & HbA1c_cat == 0 ~ 1,
      tolower(Metformin) != "sim" & (High_Fasting_Glucose >= 1 | HbA1c_cat >= 1) ~ 1,
      TRUE ~ 0
    ),
    
    # Score metabólico original
    Metabolic_Score = rowSums(across(c(
      High_Blood_Pressure, High_Fasting_Glucose, HbA1c_cat,
      BMI_cat, TRIG_cat, COL_cat, HDL_cat, LDL_cat, GGT_cat
    ), ~replace_na(., 0))),
    
    # Score com medicação
    Metabolic_Score_Medicine = Metabolic_Score + Score_Hipertensao + Score_Colesterol + Score_Glicemia
  )


#Sugestão de nova classificação para Health_Status_Medicine

metadados_grupos_saude_binario <- metadados_grupos_saude_binario %>%
  mutate(
    Health_Status_Medicine = case_when(
      Metabolic_Score_Medicine <= 1 ~ "Healthy",
      Metabolic_Score_Medicine >= 2 & Metabolic_Score_Medicine <= 4 ~ "Transition",
      Metabolic_Score_Medicine >= 5 ~ "Unhealthy"
    )
  )




#====>  Grafico de pizza representando os grupos


table(metadados_grupos_saude_binario_$Health_Status_Medicine)

```


```{r}
# Criar a tabela de frequência manualmente
grupo_tab <- as.data.frame(table(metadados_grupos_saude_binario$Health_Status_Medicine))
colnames(grupo_tab) <- c("Health Status With Medicine", "n")

# Calcular porcentagens
grupo_tab$percent <- grupo_tab$n / sum(grupo_tab$n) * 100
grupo_tab$label <- paste0("\n", grupo_tab$n, " (", round(grupo_tab$percent, 1), "%)")




# Gráfico com letras maiores
g_pizza2 <- ggplot(grupo_tab, aes(x = "", y = n, fill = `Health Status With Medicine`)) +
  geom_col(width = 1, color = "white") +
  coord_polar(theta = "y") +
  theme_void(base_size = 18) +  # Aumenta tamanho da fonte
  geom_text(aes(label = label), position = position_stack(vjust = 0.5), size = 6) +  # Texto maior
  labs(title = "Metabolic Risk Distribution with Medicine (n=105)") +
  scale_fill_brewer(palette = "Set2")

# Salvar o gráfico em alta resolução
ggsave("C:/Users/polia/OneDrive/Desktop/EstatisticaR/AgrUrbana/16S_AgriUrbana/Planilhas_UrbanAgri/Para_Dissertação/pizza_grupo_metabolico_com_medicamentos.png",
       plot = g_pizza2, width = 10, height = 8, dpi = 300)

```
# Verificação de Healthy e Unhealthy, comparando os numeros.
Sem medicamentos temos H25, T 34 e UnH 46. Contando os medicamentos, temos 16H, 29 T e 60 Unhealth

```{r}
# Carregar tidyverse se ainda não estiver
library(dplyr)

# Tabela de contingência: Health_Status x Medicamento
tabela_medicamentos <- metadados_grupos_saude_binario %>%
  group_by(Health_Status, Medication) %>%
  summarise(n = n()) %>%
  tidyr::pivot_wider(names_from = Medication, values_from = n, values_fill = 0)

# Exibir a tabela
print(tabela_medicamentos)

```

#tentando evitar distorções
*inserir uma categoria intermediária “Controlled under medication” para diferenciar pessoas que usam remédio mas estão bem controladas, em vez de já irem direto para “Unhealthy”.*

*Proposta de Categorias*
Healthy – Score total <= 1 sem uso de medicação

Controlled Medicated – Usa medicação, mas total_score_medicado ≤ 2 (parâmetros controlados)

Transition – Score total entre 2 e 4 sem medicação ou score = 2 e usa medicação

Unhealthy – Score total ≥ 5 ou uso de medicação com score ≥ 3

```{r}
library(dplyr)

metadados_grupos_saude_binario <- metadados_grupos_saude_binario %>%
  mutate(
    Medication_Flag = (Metformin == "Sim" | Statins == "Sim" | antihypertensive == 1),
    
    Health_Status_Med_Control2 = case_when(
      Metabolic_Score_Medicine <= 1 & !Medication_Flag ~ "Healthy",
      Medication_Flag & Metabolic_Score_Medicine <= 2 ~ "Controlled Medicated",
      !Medication_Flag & Metabolic_Score_Medicine >= 2 & Metabolic_Score_Medicine <= 4 ~ "Transition",
      Medication_Flag & Metabolic_Score_Medicine == 3 ~ "Transition",
      Medication_Flag & Metabolic_Score_Medicine >= 4 ~ "Unhealthy",
      Metabolic_Score_Medicine >= 6 ~ "Unhealthy",
      TRUE ~ "Transition"
    )
  )


```

Tabela de comparção entre categorias

```{r}
tabela_compar <- metadados_grupos_saude_binario %>%
  group_by(Health_Status, Health_Status_Med_Control2) %>%
  summarise(n = n(), .groups = "drop") %>%
  tidyr::pivot_wider(names_from = Health_Status_Med_Control2,
                     values_from = n, values_fill = 0)

print(tabela_compar)

```

```{r}
library(dplyr)
library(ggplot2)

library(dplyr)
library(ggplot2)

# 1. Criar tabela com contagem e porcentagem
tab_pizza <- metadados_grupos_saude_binario %>%
  count(Health_Status_Med_Control2) %>%
  mutate(
    percent = n / sum(n) * 100,
    label = paste0(Health_Status_Med_Control2, "\n", n, " (", round(percent, 1), "%)")
  )

# 2. Gerar gráfico de pizza com número e porcentagem
ggplot(tab_pizza, aes(x = "", y = n, fill = Health_Status_Med_Control2)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  coord_polar(theta = "y") +
  geom_text(aes(label = label), position = position_stack(vjust = 0.5), size = 4) +
  scale_fill_brewer(palette = "Set3") +
  theme_void() +
  labs(title = "Distribution of Health Status (with Medication Control)") +
  theme(legend.position = "none")


```



*#====================================================#*
*Health Index desmembrado em eixos funcionais de saúde*
*#====================================================#*


Criar eixos separados de risco metabólico (em vez de um índice único):

1. Eixo Glicêmico → Glicemia, HbA1c (e opcionalmente: insulina, HOMA-IR)

2. Eixo Cardiovascular → Pressão arterial, uso de anti-hipertensivos

3. Eixo Lipídico → Colesterol total, HDL, LDL, Triglicerídeos, uso de estatinas

4. Eixo Inflamatório → PCR, GGT, citocinas inflamatórias (IL-6, TNF, etc.) - **Como o eixo inflamatorio tem só 76 voluntarios, vou tira-lo dessa etapa. Vou cria-lo e fazer análises com eles separadas depois.**

Isso permite:

Identificar padrões distintos de transição.

Fazer análises multivariadas como PERMANOVA com maior clareza.

Visualizar melhor nos gráficos (ex: com gráficos ternários ou radar).

Ligar grupos bacterianos a tipos de risco (glicêmico, cardiovascular, etc).

#================

*Eixo Glicêmico → HbA1c_cat + High_Fasting_Glucose + Score_Glicemia*

*Eixo Cardiovascular → High_Blood_Pressure + Score_Hipertensao*

*Eixo Lipídico → TRIG_cat + COL_cat + HDL_cat + LDL_cat + Score_Colesterol*



Efeito da metformina (glicemia e lipídios)
A metformina reduz glicose em jejum e HbA1c, e também promove redução moderada de LDL e triglicerídeos (~10‑15%) e aumento leve de HDL (~7 %) 


Efeito das estatinas (lipídico e pressão)
As estatinas são altamente eficazes em reduzir LDL (30–50 %) e triglicerídeos, além de aumentar HDL e reduzir inflamação (CRP) e ainda ter efeito leve na pressão arterial 


Com isso, faz sentido que esses scores reflitam o impacto farmacológico nos três eixos.

Justificativa da inclusão dos scores
*Score_Glicemia: captura risco residual glicêmico mesmo com medicação* — por isso faz parte do eixo glicêmico.

*Score_Hipertensao: mesmo com anti-hipertensivos, se a pressão continua alta, isso indica falha ou dependência.*

*Score_Colesterol: idem para lipídios — mesmo com estatinas, se as categorias de colesterol estão alteradas, isso indica risco residual.*

**Como soma para cada eixo funciona**
Cada eixo é a soma de parâmetros clínicos normais/alterados + pontuação por uso de medicamento, refletindo:

O estado biológico atual (níveis de biomarcadores)

A dependência ou falha terapêutica (uso de medicação)

#***Calculo Eixos Ajustados***#

```{r}
library(dplyr)

metadados_grupos_saude_binario <- metadados_grupos_saude_binario %>%
  mutate(
    eixo_glic = High_Fasting_Glucose + HbA1c_cat + Score_Glicemia,
    eixo_cardio = High_Blood_Pressure + Score_Hipertensao,
    eixo_lipid = TRIG_cat + COL_cat + HDL_cat + LDL_cat + Score_Colesterol
  ) %>%
  mutate(total_med = eixo_glic + eixo_cardio + eixo_lipid) %>%
  filter(total_med > 0) %>%
  mutate(
    Glic = eixo_glic / total_med,
    Cardio = eixo_cardio / total_med,
    Lipid = eixo_lipid / total_med
  )

```

*GRAFICO TERNARIO (Usando proporção e gravidade/frequencia)*

```{r}

library(ggtern)
library(dplyr)

dados_tern_count <- metadados_grupos_saude_binario %>%
  group_by(Glic, Cardio, Lipid) %>%
  summarise(
    n = n(),
    mean_total = mean(total_med),
    .groups = "drop"
  )

ggtern(dados_tern_count, aes(x = Glic, y = Cardio, z = Lipid)) +
  geom_point(aes(size = n, color = mean_total), alpha = 0.8) +
  scale_color_gradient(low = "lightblue", high = "darkred") +
  scale_size_continuous(range = c(6, 16)) +
  theme_bw() +
  theme(
    tern.axis.title.T = element_text(margin = margin(b = 10)),
    tern.axis.title.L = element_text(margin = margin(t = 10)),
    tern.axis.title.R = element_text(margin = margin(t = 10))
  ) +
  labs(
    title = "Metabolic Profile With Medicine: Severity vs Frequency",
    T = "Glycemic", L = "Cardiovascular", R = "Lipidic",
    color = "Mean Total Score", size = "Number of People"
  )


```

*GRAFICO RADAR*


```{r}
library(fmsb)

# Média dos eixos por grupo
radar_data1 <- metadados_grupos_saude_binario %>%
  group_by(Health_Status_Medicine) %>%
  summarise(
    eixo_glic = mean(eixo_glic, na.rm = TRUE),
    eixo_cardio = mean(eixo_cardio, na.rm = TRUE),
    eixo_lipid = mean(eixo_lipid, na.rm = TRUE),
    .groups = "drop"
  )

# Ajuste para formato fmsb (com limites)
maxvals <- apply(radar_data1[,2:4], 2, max)
minvals <- c(0, 0, 0)

radar_df1 <- rbind(maxvals, minvals, radar_data1[,2:4])
row.names(radar_df1) <- c("max", "min", radar_data1$Health_Status_Medicine)

# cores para cada categoria
colors <- c("green", "gold", "red")[1:nrow(radar_data1)]

radarchart(
  radar_df1,
  axistype = 1,
  pcol = colors,
  pfcol = adjustcolor(colors, alpha.f = 0.3),
  plwd = 2,
  plty = 1,
  cglcol = "grey",
  cglty = 1,
  axislabcol = "grey",
  cglwd = 0.8,
  vlcex = 0.8,
  title = "Metabolic Score by Axis and Status"
)

# Inserir legenda dentro do gráfico
legend(
  x = 0.8, y = 0.8,                        # posição dentro do plot (ajuste conforme necessidade)
  legend = rownames(radar_df1)[-c(1,2)],   # nomes dos grupos
  col = colors,
  pch = 16,
  bty = "n",
  pt.cex = 1.5,
  cex = 0.8
)
```


```{r}
library(fmsb)

# Média dos eixos por grupo
radar_data <- metadados_grupos_saude_binario %>%
  group_by(Health_Status_Med_Control2) %>%
  summarise(
    eixo_glic = mean(eixo_glic, na.rm = TRUE),
    eixo_cardio = mean(eixo_cardio, na.rm = TRUE),
    eixo_lipid = mean(eixo_lipid, na.rm = TRUE),
    .groups = "drop"
  )

# Ajuste para formato fmsb (com limites)
maxvals <- apply(radar_data[,2:4], 2, max)
minvals <- c(0, 0, 0)

radar_df <- rbind(maxvals, minvals, radar_data[,2:4])
row.names(radar_df) <- c("max", "min", radar_data$Health_Status_Med_Control2)

# cores para cada categoria
colors <- c("green", "gold", "orange", "red")[1:nrow(radar_data)]

radarchart(
  radar_df,
  axistype = 1,
  pcol = colors,
  pfcol = adjustcolor(colors, alpha.f = 0.3),
  plwd = 2,
  plty = 1,
  cglcol = "grey",
  cglty = 1,
  axislabcol = "grey",
  cglwd = 0.8,
  vlcex = 0.8,
  title = "Metabolic Score by Axis and Status"
)

# Inserir legenda dentro do gráfico
legend(
  x = 0.8, y = 0.8,                        # posição dentro do plot (ajuste conforme necessidade)
  legend = rownames(radar_df)[-c(1,2)],   # nomes dos grupos
  col = colors,
  pch = 16,
  bty = "n",
  pt.cex = 1.5,
  cex = 0.8
)

```

